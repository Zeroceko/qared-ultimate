<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qared</title>
  <link href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#152A32; --card:#1a3440; --card2:#213d48;
      --text:#FFFCEE; --muted:rgba(255,252,238,.6); --muted2:rgba(255,252,238,.35);
      --border:rgba(255,252,238,.10);
      --green:#91FF00; --greenBg:rgba(145,255,0,.12);
      --red:#FF6B6B; --redBg:rgba(255,107,107,.12);
      --amber:#ffc107; --amberBg:rgba(255,193,7,.12);
      --radius:14px; --radiusSm:10px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Bai Jamjuree',system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text);padding:16px}
    .wrap{max-width:1280px;margin:0 auto}
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:14px}
    h1{margin:0;font-size:28px;letter-spacing:-.5px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:12px 18px;font-weight:800;cursor:pointer}
    #getBtn{background:var(--green);color:#102026}
    #getBtn:disabled{opacity:.5;cursor:not-allowed}
    .pill{border:1px solid rgba(145,255,0,.25);background:rgba(145,255,0,.08);color:var(--green);
      border-radius:999px;padding:7px 12px;font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700}
    .sliderBox{display:flex;align-items:center;gap:10px;background:rgba(255,252,238,.06);border:1px solid var(--border);
      padding:8px 12px;border-radius:12px}
    .sliderBox label{font-size:12px;color:var(--muted)}
    .sliderBox input[type="range"]{width:160px}
    .sliderVal{font-family:'JetBrains Mono',monospace;font-weight:800}
    .info{display:none;margin:10px 0 14px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);color:var(--muted);background:rgba(255,252,238,.04)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
    .head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding-bottom:10px;border-bottom:1px solid rgba(255,252,238,.08);margin-bottom:10px}
    .sym{font-family:'JetBrains Mono',monospace;font-weight:900}
    .badge{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:900;padding:2px 8px;border-radius:7px}
    .preview{background:rgba(255,193,7,.15);color:var(--amber)}
    .confirmed{background:rgba(145,255,0,.12);color:var(--green)}
    .dir{display:flex;align-items:center;justify-content:center;border-radius:12px;padding:10px 12px;font-family:'JetBrains Mono',monospace;font-weight:900;letter-spacing:2px;margin-bottom:10px}
    .long{background:var(--greenBg);color:var(--green);border:1px solid rgba(145,255,0,.25)}
    .short{background:var(--redBg);color:var(--red);border:1px solid rgba(255,107,107,.25)}
    .prices{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .cell{background:var(--bg);border:1px solid rgba(255,252,238,.08);border-radius:12px;padding:10px}
    .lab{font-size:11px;color:var(--muted2);text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
    .val{font-family:'JetBrains Mono',monospace;font-size:13px;font-weight:900}
    .subline{font-size:11px;color:var(--muted2);margin-top:6px;line-height:1.2}
    .bar{height:6px;background:rgba(255,252,238,.06);border-radius:999px;overflow:hidden;margin:10px 0 8px}
    .fill{height:100%;background:linear-gradient(90deg,var(--green),#c9b5ff);border-radius:999px}
    .row{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
    .warn{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .wtag{font-size:11px;border-radius:7px;padding:3px 7px;background:rgba(255,107,107,.10);color:var(--red);border:1px solid rgba(255,107,107,.18)}
    .btn2{margin-top:10px;width:100%;background:var(--amberBg);border:1px solid rgba(255,193,7,.25);color:var(--amber)}
    .empty{grid-column:1/-1;text-align:center;padding:26px;border:1px solid var(--border);border-radius:var(--radius);background:rgba(255,252,238,.03);color:var(--muted)}
    .error{margin:10px 0;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,107,107,.25);background:rgba(255,107,107,.10);color:var(--red);display:none}
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Qared</h1>
      <div class="sub">BreakoutProp â€¢ x20 KaldÄ±raÃ§ â€¢ Sinyal filtre eÅŸiÄŸi kullanÄ±cÄ± seÃ§er</div>
    </div>
    <div class="controls">
      <button id="getBtn">Yeni Ã–neriler Al</button>
      <span class="pill">x20</span>
      <div class="sliderBox">
        <label for="minConf">Min GÃ¼ven</label>
        <input id="minConf" type="range" min="0" max="80" step="1" />
        <span class="sliderVal" id="minConfVal">0</span>
      </div>
    </div>
  </div>

  <div class="info" id="info"></div>
  <div class="error" id="err"></div>
  <div class="grid" id="grid"></div>
</div>

<script>
  // EÄŸer bu sayfayÄ± Netlify dÄ±ÅŸÄ±nda host ediyorsan (GitHub Pages vs),
  // API_BASE'i Netlify sitenin tam URL'siyle deÄŸiÅŸtir:
  // const API_BASE = "https://SITENAME.netlify.app/.netlify/functions/trade-bot";
  const API_BASE = "/.netlify/functions/trade-bot";
  const LEVERAGE = 20;

  const elBtn = document.getElementById("getBtn");
  const elGrid = document.getElementById("grid");
  const elInfo = document.getElementById("info");
  const elErr = document.getElementById("err");
  const elMin = document.getElementById("minConf");
  const elMinVal = document.getElementById("minConfVal");

  function loadMinConf(){
    const v = Number(localStorage.getItem("min_conf") ?? "0");
    const vv = Number.isFinite(v) ? Math.max(0, Math.min(80, v)) : 0;
    elMin.value = String(vv);
    elMinVal.textContent = String(vv);
    return vv;
  }
  function setMinConf(v){
    localStorage.setItem("min_conf", String(v));
    elMinVal.textContent = String(v);
  }

  let minConf = loadMinConf();
  elMin.addEventListener("input", (e)=>{ minConf = Number(e.target.value); setMinConf(minConf); });

  function showErr(msg){
    elErr.textContent = msg;
    elErr.style.display = "block";
    setTimeout(()=>{ elErr.style.display="none"; }, 9000);
  }

  function fmt(p){
    if (!Number.isFinite(p)) return "â€”";
    if (p >= 10000) return p.toFixed(0);
    if (p >= 100) return p.toFixed(1);
    if (p >= 1) return p.toFixed(2);
    if (p >= 0.01) return p.toFixed(4);
    return p.toFixed(6);
  }

  function rrStr(rr){
    if(!Number.isFinite(rr)) return "â€”";
    return rr.toFixed(1) + ":1";
  }

  function confLabel(c){
    if(c>=75) return "YÃ¼ksek";
    if(c>=68) return "Orta-YÃ¼ksek";
    if(c>=60) return "Orta";
    return "DÃ¼ÅŸÃ¼k";
  }

  function warnTR(w){
    const m = {
      "FUNDING_RATE_HIGH":"FUNDING_RATE_HIGH",
      "LIQ_INTENSITY_HIGH":"LIQ_INTENSITY_HIGH",
      "LIQ_INTENSITY_MED":"LIQ_INTENSITY_MED",
      "LIQ_INTENSITY_LOW":"LIQ_INTENSITY_LOW",
      "LIQ_ALIGNS_WITH_SIGNAL":"LIQ_ALIGNS_WITH_SIGNAL"
    };
    return m[w] || w;
  }

  function fetchSignals(){
    const url = `${API_BASE}?mode=intrabar&min_conf=${encodeURIComponent(minConf)}`;
    return fetch(url, { cache:"no-store" })
      .then(r => r.json().then(d => ({ ok:r.ok, data:d })))
      .then(({ok, data}) => {
        if(!ok || !data || data.ok !== true) throw new Error((data && (data.error || data.message)) || "API error");
        return data;
      });
  }

  function renderEmpty(meta){
    elGrid.innerHTML = `<div class="empty">
      <div style="font-size:32px;margin-bottom:6px;">ðŸ“Š</div>
      <div>Åžu an <b>${minConf}+</b> gÃ¼venle sinyal yok.</div>
      <div style="margin-top:6px;color:rgba(255,252,238,.45);font-size:12px;">
        ${meta?.errors?.length ? (meta.errors.length + " hata") : "Hata yok"} â€¢ ${meta?.ms ? (meta.ms + "ms") : ""}
      </div>
    </div>`;
  }

  function renderSignals(signals){
    elGrid.innerHTML = "";
    signals.forEach(sig => {
      if(!sig || sig.mode==="ERROR" || sig.mode==="INVALIDATED") return;

      const isLong = sig.direction === "LONG";
      const entry = Number(sig.entryRefPrice);
      const tp = Number(sig.tpPrice);
      const sl = Number(sig.slPrice);
      const conf = Number(sig.confidence || 0);
      const rr = Number(sig.meta?.rr || 0);
      const atr = Number(sig.meta?.atr || 0);
      const slAtrMult = Number(sig.meta?.slAtrMult || 0);

      // hareket % (unlevered)
      const tpMove = entry>0 ? ((tp-entry)/entry*100) : NaN;
      const slMove = entry>0 ? ((sl-entry)/entry*100) : NaN;

      // approx x20 PnL
      const tpLev = Math.abs(tpMove) * LEVERAGE;
      const slLev = Math.abs(slMove) * LEVERAGE;

      const warns = (sig.warnings || []).map(warnTR);

      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="head">
          <div class="sym">${sig.symbol}</div>
          <div class="badge ${sig.mode==="PREVIEW" ? "preview":"confirmed"}">${sig.mode}</div>
        </div>
        <div class="dir ${isLong?"long":"short"}">${isLong?"LONG":"SHORT"}</div>
        <div class="prices">
          <div class="cell">
            <div class="lab">GiriÅŸ (ref)</div>
            <div class="val">$${fmt(entry)}</div>
          </div>
          <div class="cell" style="border-color: rgba(145,255,0,.18)">
            <div class="lab">TP</div>
            <div class="val" style="color:var(--green)">$${fmt(tp)}</div>
            <div class="subline">${Number.isFinite(tpMove)?tpMove.toFixed(2):"â€”"}% â€¢ â‰ˆ +${Number.isFinite(tpLev)?tpLev.toFixed(1):"â€”"}% (x${LEVERAGE})</div>
          </div>
          <div class="cell" style="border-color: rgba(255,107,107,.18)">
            <div class="lab">SL</div>
            <div class="val" style="color:var(--red)">$${fmt(sl)}</div>
            <div class="subline">${Number.isFinite(slMove)?slMove.toFixed(2):"â€”"}% â€¢ â‰ˆ -${Number.isFinite(slLev)?slLev.toFixed(1):"â€”"}% (x${LEVERAGE})</div>
          </div>
        </div>

        <div class="bar"><div class="fill" style="width:${Math.max(0,Math.min(100,conf))}%"></div></div>
        <div class="row">
          <span>${confLabel(conf)}</span>
          <span style="font-family:'JetBrains Mono',monospace;font-weight:900;">%${conf}</span>
        </div>

        <div class="row" style="margin-top:6px;">
          <span>R/R</span><span class="pill" style="border-color: rgba(201,181,255,.25); color:#c9b5ff; background:rgba(201,181,255,.08)">${rrStr(rr)}</span>
        </div>

        <div class="row" style="margin-top:6px;">
          <span>ATR</span><span style="font-family:'JetBrains Mono',monospace;">${Number.isFinite(atr)?atr.toFixed(4):"â€”"} â€¢ SLÃ—${Number.isFinite(slAtrMult)?slAtrMult:"â€”"}</span>
        </div>

        ${warns.length ? `<div class="warn">${warns.map(w=>`<span class="wtag">${w}</span>`).join("")}</div>` : "" }
      `;
      elGrid.appendChild(card);
    });
  }

  function setInfo(msg){
    elInfo.textContent = msg;
    elInfo.style.display = "block";
  }

  function refresh(){
    elBtn.disabled = true;
    elGrid.innerHTML = "";
    elInfo.style.display="none";
    elErr.style.display="none";

    fetchSignals()
      .then(data => {
        const sigs = (data.signals || []).slice().sort((a,b)=>Number(b.confidence||0)-Number(a.confidence||0));
        setInfo(`Min gÃ¼ven: ${minConf} â€¢ ${sigs.length} sinyal â€¢ ${data.errors?.length||0} hata â€¢ ${data.ms}ms`);
        if(!sigs.length) return renderEmpty(data);
        renderSignals(sigs.slice(0, 9));
      })
      .catch(e => {
        console.error(e);
        showErr(e.message || "Hata");
        renderEmpty({ errors:[{error:e.message}]});
      })
      .finally(()=>{ elBtn.disabled=false; });
  }

  elBtn.addEventListener("click", refresh);
</script>
</body>
</html>
